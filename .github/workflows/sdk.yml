name: SDK

on:
  workflow_call:

jobs:
  package_sdk:
    name: Package SDK
    strategy:
      fail-fast: false
      matrix:
        macos_versions:
          - 12
          - 13
          - 14
    runs-on: macos-${{ matrix.macos_versions }}
    outputs:
      RELEASE_VERSION: ${{ steps.get_release_version.outputs.RELEASE_VERSION }}
    steps:
      - uses: actions/checkout@v4

      - name: Get Release Version
        id: get_release_version
        run: |
          echo "RELEASE_VERSION=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: SDK Package
        run: |
          xcode-select -p
          xcodebuild -version
          xcodebuild -showsdks
          ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV
          for xcode in $(ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV); do
            sed 's|for SDK in $SDKS; do|for SDK in $SDKS; do\n[ -f "$WDIR/$SDK$SDK_EXT" ] \&\& continue|g' tools/gen_sdk_package.sh | \
            XCODEDIR=/Applications/$xcode SDK_COMPRESSOR=xz bash -s -- iPhoneOS
            sed 's|for SDK in $SDKS; do|for SDK in $SDKS; do\n[ -f "$WDIR/$SDK$SDK_EXT" ] \&\& continue|g' tools/gen_sdk_package.sh | \
            XCODEDIR=/Applications/$xcode SDK_COMPRESSOR=xz bash -s -- iPhoneSimulator
          done
          mkdir -p sdk-${{ matrix.macos_versions }}
          mv *.sdk.tar.xz sdk-${{ matrix.macos_versions }}

      - name: Upload SDK
        id: upload_sdk
        uses: actions/upload-artifact@v4
        with:
          name: sdk-${{ matrix.macos_versions }}
          path: sdk-${{ matrix.macos_versions }}
          compression-level: 0

  collect_sdks:
    name: Collect SDKs
    runs-on: ubuntu-latest
    needs: package_sdk
    steps:
      - name: Collect SDK
        id: collect_sdk
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            execSync('npm install @actions/artifact');
            const { DefaultArtifactClient } = require('@actions/artifact');
            const artifact = new DefaultArtifactClient();
            const fs = require('fs');

            const allArtifacts = await artifact.listArtifacts();
            const sdkArtifacts = allArtifacts.artifacts.filter(a => a.name.startsWith('sdk-'));
            for (const sdkArtifact of sdkArtifacts) {
              console.log('download', sdkArtifact);
              await artifact.downloadArtifact(sdkArtifact.id);
            }

            const sdkFolders = fs.readdirSync('.').filter(folder => folder.startsWith('sdk-'));
            for (const folder of sdkFolders) {
              const sdkFiles = fs.readdirSync(folder).filter(file => file.endsWith('.sdk.tar.xz'));
              for (const file of sdkFiles) {
                console.log(`collect ${folder}/${file}`);
                const sourcePath = `${folder}/${file}`;
                const destinationPath = `../${file}`;
                fs.renameSync(sourcePath, destinationPath);
              }
            }

            const files = fs.readdirSync('.');
            for (const file of files) {
              if (!file.endsWith('.sdk.tar.xz') || (!file.startsWith('iPhoneOS') && !file.startsWith('iPhoneSimulator'))) {
                continue;
              }
              const name = file.replace(/\.sdk\.tar\.xz$/, '').replace('.', '-');
              if (name === 'iPhoneOS' || name === 'iPhoneSimulator') {
                continue;
              }

              const maxRetries = 3;
              let retries = 0;
              let success = false;

              while (retries < maxRetries && !success) {
                try {
                  await artifact.uploadArtifact(
                    name,
                    [file],
                    '.',
                    {
                      compressionLevel: 0
                    }
                  );
                  success = true;
                } catch (error) {
                  console.error(`upload ${name} failed, retry ${retries + 1}, error: ${error.message}`);
                  retries++;
                  if (retries < maxRetries) {
                    try {
                      await artifact.deleteArtifact(name);
                    } catch (deleteError) {}
                  }
                }
              }

              if (!success) {
                throw new Error(`upload ${name} failed`);
              }
            }
